# Репозиторий команды Defective Pie на Eurobot Open 2023
## Разработку вели:
* [Попов Максим](https://github.com/warmhammer) (Tech Lead)
* [Данилов Валерий](https://github.com/ArcherBTD) (Embedded / STM32)
* [Норматов Музаффар](https://github.com/mnormatov2001) (Computer Vision)

### По мотивам разработки мы защищали дипломы бакалавра:
* [Планирование движений робота в соревнованиях “Евробот”](https://docs.google.com/presentation/d/1fr5g8CXUArKWf3GTjmxWFYFV9tfaEbzRI8hKjw0zdxc/edit?usp=sharing)
* [Мобильный робот для соревнований "Евробот"](https://disk.yandex.ru/d/c4PaddmryqoMPg)
* [Управление группой мобильных роботов с использованием системы технического зрения](https://drive.google.com/file/d/1nxk7QWcqGhzuHf2DICc2YA-zhSsg4LF9/view?usp=sharing)

### По вопросам писать:
* tg: @wrmhmmr
* e-mail: max.popov.02@ya.ru

# Статус разработки
Команда разъехалась по разным городам и разработка закончилась.

### Успели сделать
* Поднять ROS
* Описать робота в UDRF
* Настроить связь с STM, написать драйверы для BLDC двигателей и запустить ROS контроллеры движения
* Поднять карту и стандартный планер маршрутов
* Поднять интерфейс конечных автоматов

### Не успели сделать
* Поднять локализацию (колесная одометрия не в счет)
* Разработать систему предотвращения столкновений
* Написать конечные автоматы
* Идеально настроить `move_base`, скорее всего нужно писать свой стек навигации
* Отладить и отдебажить

-------

# Главы для разработчиков

1. [Настройка системы](#Настройка-системы)
    1. [Подключение к роботу по SSH](#Подключение-к-роботу-по-SSH)
    2. [VSCode и SSH](#VSCode-и-SSH)
    3. [Настройка ROS Multiple machines](#Настройка-ROS-Multiple-machines)
    4. [Импорт проекта STM32](#Импорт-проекта-STM32)
2. [Работа в системе](#Работа-в-системе)
    1. [Экспорт URDF в RVIZ](#Экспорт-URDF-в-RVIZ)

# Настройка системы
## Подключение к роботу по SSH
0) Если вы используете виртуальную машину, то сеть нужно настроить через мост.
1) На обоих системах (робот и ваш компьютер) внести изменения в `/etc/hosts` (скорее всего надо использовать sudo)
```
local-ip-pc     pc-name
local-ip-robot  robot-name
```
Например
```
192.168.1.8   maxim
192.168.1.12  orangepi4-lts
```

Свой ip можно узнать, например, через ifconfig (должен начинаться на 192.168), ifconfig надо установить. ip робота узнается либо подключением робота к компьютеру, либо в настройке роутера, либо ***у товарищей***. ip меняется на разных роутерах.

2) Если все настроено верно, то получится подключится к роботу так:

```
ssh robot-user-name@robot-name
```
Например

```
ssh orangepi@orangepi4-lts
```
После чего система может задать вопрос про fingerprint, ответить yes. Далее ввести пароль робота и пользоваться им.

3) **БОНУС:** подключение по хэш-ключу. Генерируем сам ключ: 
```
ssh-keygen  # Читаем то, что пишет утилита
``` 
Не советую менять путь файла, по которму записывается ключ! Далее подключаемся по SSH с копированием ключа:
```
ssh-copy-id robot-user-name@robot-name
```
Всё!

## VSCode и SSH
VSCode умеет дружить с SSH. Это удобно, т.к. по SSH очень плохо отрисовываются графические интерфейсы (он для этого просто не создан). Чтобы копаться в файлах робота через SSH надо всего лишь:
1) Скачать дополнение Remote Development от Microsoft
2) Добавить цель (ssh target во вкладке Remote Expoler). Та же команда, что и обычно.
3) Указать ssh конфиг. У меня это `/home/user-name/.ssh/config`. Сам VSCode предложит варанты. В этом пункте могут быть проблемы, если у SSH поменять порт, но мы пока ничего не меняем.

## Настройка ROS Multiple machines
0) Проверить, что правильно внесены найстройки в `/etc/hosts` (прошлый пункт)
1) На обоих машинах внести изменения в `~/.bashrc` (это конфиг bash терминала, надеюсь вы сидите на ubuntu...). То есть изменения возникнут только после перезагрузки терминала.
```
# Строка отвечает за настройку bash под ROS. Так у вас будут сразу работать ROS-команды и выгрузятся ROS-переменные 
source /opt/ros/noetic/setup.bash 

# ROS-переменные для настройки multiple machines
ROS_MASTER_URI=http://master_name:11311/
ROS_HOSTNAME=machine_name
ROS_IP=machine_ip
```
Мы настраиваем так, чтобы ваш компьютер был мастером (он создает roscore, на нем запускаются все "тяжелые" ноды). Поэтому на вашем пк `machine_name` и `master_name` совпадают. На всех машинах `master_name` одинаковый. `machine_name` - имя вашего ПК, у меня это `ROS_HOSTNAME=maxim`. Проверьте, чтобы ROS_IP совпадали с теми, что написаны в `hosts`. Пример с orangepi:
```
ROS_MASTER_URI=http://maxim:11311/
ROS_HOSTNAME=orangepi4-lts
ROS_IP=192.168.1.12
```
2) Если все настроено верно, то запустите на вашем компьютере `roscore`. Тогда команда `rostopic list` на роботе должна показать запущенные топики.

## Импорт проекта STM32
0) С официального сайта установить CUBE IDE россиянам просто так не получится. Чтобы получить bash-скрипт установки либо зайдите на сайт через VPN (или TOR), либо попросите его у товарищей.
1) Для начала надо стянуть изменения из удаленного репозитория. При входе в CUBE IDE выберите в качестве workspace папку проекта. У нас это `eurobot_23`. 
2) Далее `File -> New -> STM32 Project from an Existing STM32CubeMX Configuration File (.ioc)`. Выберите `.ioc` файл (лежит в корне проекта) из импортируемого проекта (например, Eurobot2023). Должен подгрузиться искомый проект.
3) Если при сборке проекта возникла ошибка (или похожая): 
```
arm-none-eabi-gdb: error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory
```
то необходимо поставить следующую библиотечку:
```
sudo apt install libncurses5
```

# Работа в системе
## Экспорт URDF в RVIZ
0) Устанавливаем экспортер для SolidWorks (у нас 21 версия). https://wiki.ros.org/sw_urdf_exporter
1) Экспортируем архив с urdf (сохраняя настройки с диска). Архив должен называться `dolly_description.zip`
2) Переносим архив на Linux. Запускаем скрипт преобразования архива (находясь в папке проекта):
```
./scripts/description_archive_parsep.py [путь_до_архива]
```
Если так не запускается, то скорее всего у парсера нет прав. Надо дать:
```
chmod +x ./scripts/description_archive_parsep.py
```
